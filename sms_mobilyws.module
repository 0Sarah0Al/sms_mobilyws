<?php

/**
 * @file
 * Adds support for sending SMS messages using the Mobily.ws gateway.
 */

module_load_include('inc', 'sms_mobilyws', 'convertToUnicode');

/**
 * Implements hook_gateway_info().
 */
function sms_mobilyws_gateway_info() {
  return array(
    'mobilyws' => array(
      'name' => 'Mobily.ws',
      'configure form' => 'sms_mobilyws_admin_form',
      'send' => 'sms_mobilyws_send',
      'send form' => 'sms_mobilyws_send_form',
    ),
  );
}

/**
 * Configuration form for gateway module.
 */
function sms_mobilyws_admin_form($configuration) {

  $sms_status = _get_sms_status();
  $form['sms_mobilyws_status'] = array(
    '#type' => 'textfield',
    '#title' => t('Mobily.ws Serivce Status'),
    '#default_value' => $sms_status['message'],
    '#description' => t('!Mobily.ws serivce availability.', array(
      '!Mobily.ws' => '<a target="_blank" href="http://mobily.ws">Mobily.ws</a>',
    )),
    '#size' => 30,
    '#disabled' => TRUE,
    '#maxlength' => 64,
    '#required' => FALSE,
  );

  $sms_balance = sms_mobilyws_balance();
  $form['sms_mobilyws_balance'] = array(
    '#type' => 'textfield',
    '#title' => t('Your Balance'),
    '#default_value' => $sms_balance['balance'],
    '#description' => t('The current balance of your !Mobily.ws gateway account.', array(
      '!Mobily.ws' => '<a target="_blank" href="http://mobily.ws">Mobily.ws</a>',
    )) . ' <br /><strong>' . $sms_balance['message'] . '</strong>',
    '#size' => 30,
    '#disabled' => TRUE,
    '#maxlength' => 64,
    '#required' => FALSE,
  );

  $form['sms_mobilyws_sender'] = array(
    '#type' => 'textfield',
    '#title' => t('Sender'),
    '#description' => t('The sender name of your !Mobily.ws gateway account.', array(
      '!Mobily.ws' => '<a target="_blank" href="http://mobily.ws">Mobily.ws</a>',
    )),
    '#size' => 40,
    '#maxlength' => 255,
    '#default_value' => (isset($configuration) && isset($configuration['sms_mobilyws_sender'])) ? $configuration['sms_mobilyws_sender'] : '',
  );

  $form['sms_mobilyws_user'] = array(
    '#type' => 'textfield',
    '#title' => t('User'),
    '#description' => t('The username of your !Mobily.ws gateway account.', array(
      '!Mobily.ws' => '<a target="_blank" href="http://mobily.ws">Mobily.ws</a>',
    )),
    '#size' => 40,
    '#maxlength' => 255,
    '#default_value' => (isset($configuration) && isset($configuration['sms_mobilyws_user'])) ? $configuration['sms_mobilyws_user'] : '',
  );

  // Show note if there is already saved password.
  $leave_blank_note = '';
  if (isset($configuration['sms_mobilyws_password']) && (strlen($configuration['sms_mobilyws_password']) > 0)) {
    $leave_blank_note = t('Leave blank to use the same saved password.');
  }
  $form['sms_mobilyws_password'] = array(
    '#type' => 'password',
    '#title' => t('Password'),
    '#description' => t('The password of your !Mobily.ws gateway account.', array(
      '!Mobily.ws' => '<a target="_blank" href="http://mobily.ws">Mobily.ws</a>',
    )) . '<br /><strong>' . $leave_blank_note . '</strong>',
    '#size' => 30,
    '#maxlength' => 64,
    '#default_value' => '',
  );

  $form['#validate'][] = 'sms_mobilyws_admin_form_validate';
  return $form;
}

/**
 * Validate admin form.
 */
function sms_mobilyws_admin_form_validate(&$form, &$form_state) {
  // Save the same password if the field value is empty.
  if ($form_state['values']['sms_mobilyws_password'] == '') {
    $gateway = sms_gateways('gateway', 'mobilyws');
    if (isset($gateway['configuration']['sms_mobilyws_password'])) {
      form_set_value($form['sms_mobilyws_password'], $gateway['configuration']['sms_mobilyws_password'], $form_state);
    }
  }
}

/**
 * Callback for sending messages.
 */
function sms_mobilyws_send($number, $message, $options) {

  $gateway = sms_gateways('gateway', 'mobilyws');
  $config = $gateway['configuration'];

  $url = "http://www.mobily.ws/api/msgSend.php";
  $application_type = "24";
  $msg = convertToUnicode($message);
  $sendr = $config['sms_mobilyws_sender'];
  $sender = urlencode($sendr);

  // @TODO: make sure this variable is defined $options['country'] before call it here.
  $string_to_post = "mobile=" . $config['sms_mobilyws_user'] . "&password=" . $config['sms_mobilyws_password'] . "&numbers=" . $options['country'] . $number . "&sender=" . $sender . "&msg=" . $msg . "&applicationType=" . $application_type;

  $ch = curl_init();
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_HEADER, 0);
  curl_setopt($ch, CURLOPT_TIMEOUT, 5);
  curl_setopt($ch, CURLOPT_POST, 1);
  curl_setopt($ch, CURLOPT_POSTFIELDS, $string_to_post);

  $result = curl_exec($ch);

  // Defined messages by keys as documentation.
  $response_codes = array();
  $response_codes[1] = t('Sent successfully.');
  $response_codes[2] = t('Your balance is 0.');
  $response_codes[3] = t('You do not have an sufficient balance.');
  $response_codes[4] = t('Incorrect username (mobile number).');
  $response_codes[5] = t('Incorrect password.');
  $response_codes[6] = t('No response from gateway. Please try again.');
  $response_codes[13] = t('Sender name is not acceptable.');
  $response_codes[14] = t('Sender name is not defined.');
  $response_codes[15] = t('Mobile number field is not correct or empty.');
  $response_codes[16] = t('Sender name is empty.');
  $response_codes[17] = t('Message text is not encrypted correctly.');
  $response_codes[18] = t('Sending has been suspended from provider.');
  $response_codes[19] = t('applicationType parameter is required.');

  if (!isset($response_codes[$result]) || !is_numeric($response_codes[$result])) {
    // Response structure is not correct or has been changed.
    $response_array = array(
      'status' => FALSE,
      'message' => t('An error occurred during the HTTP request.'),
      'data' => array('response' => $result),
    );
    return $response_array;
  }

  // Check statuses.
  switch ($result) {
    case '1':
      // As per Mobily.ws documentation 1 = Success.
      $response_array = array(
        'status' => TRUE,
        'message' => $response_codes[$result],
        'data' => array(),
      );
      break;

    default:
      // Check if status code has defined message in $response_codes messages.
      if (isset($response_codes[$result])) {
        $response_array = array(
          'status' => FALSE,
          'message' => $response_codes[$result],
          'data' => array(),
        );
      }
      else {
        // Response code is not implemented.
        $response_array = array(
          'status' => FALSE,
          'message' => t('Status code in response is not implemented.'),
          'data' => array(),
        );
      }
      break;
  }

  return $result;
}


/**
 * Get the balance of your account.
 */
function sms_mobilyws_balance() {

  $gateway = sms_gateways('gateway', 'mobilyws');

  // Check if gateway configuration is already defined or not.
  if (!isset($gateway['configuration']) || !isset($gateway['configuration']['sms_mobilyws_user']) || !isset($gateway['configuration']['sms_mobilyws_password'])) {
    // There is no configuration yet.
    $respons_array['status'] = '3';
    $respons_array['total'] = '0';
    $respons_array['balance'] = '0';
    $respons_array['message'] = t('Please save your @provider configurations so you can see your balance.', array('@provider' => t('Mobily.ws')));
    return $respons_array;
  }

  $config = $gateway['configuration'];

  $url = "http://www.mobily.ws/api/balance.php";
  $string_to_post = "mobile=" . $config['sms_mobilyws_user'] . "&password=" . $config['sms_mobilyws_password'];
  $ch = curl_init();
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_HEADER, 0);
  curl_setopt($ch, CURLOPT_TIMEOUT, 5);
  curl_setopt($ch, CURLOPT_POST, 1);
  curl_setopt($ch, CURLOPT_POSTFIELDS, $string_to_post);
  $result = curl_exec($ch);

  // Defined messages by keys as documentation.
  $array_balance = array();
  $array_balance[0] = t('Can not connect to Mobily.ws server.');
  $array_balance[1] = t('Mobile number (username) is not correct.');
  $array_balance[2] = t('Password is not correct.');

  $respons_array = array();

  if (isset($array_balance[$result])) {
    // Error response.
    $respons_array['status'] = '0';
    $respons_array['total'] = '0';
    $respons_array['balance'] = '0';
    $respons_array['message'] = $array_balance[$result];
    return $respons_array;
  }

  // Check result.
  if (strstr($result, '/')) {
    $balance = explode('/', $result);
    // Correct result.
    // Successful.
    $respons_array['status'] = '1';
    $respons_array['total'] = $balance[0];
    $respons_array['balance'] = $balance[1];
    $respons_array['message'] = t('Your current balance is @balance points from @total_balance points.', array('@balance' => $balance[1], '@total_balance' => $balance[0]));
    return $respons_array;
  }

  // Response structure is not correct.
  $respons_array['status'] = '2';
  $respons_array['total'] = '0';
  $respons_array['balance'] = '0';
  $respons_array['message'] = t('Response structure is not correct. Please contact support team.');
  return $respons_array;
}

/**
 * Get the Availablity of your account.
 */
function _get_sms_status() {

  $context_options['http'] = array(
    'method' => 'GET',
    'max_redirects' => 0,
    'protocol_version' => 1.0,
    'timeout' => 10,
    'ignore_errors' => TRUE,
  );

  $context_resouce  = stream_context_create($context_options);
  $url = "http://www.mobily.ws/api/sendStatus.php";
  $result = file($url, FILE_IGNORE_NEW_LINES, $context_resouce);

  $array_send_status = array();
  $array_send_status[0] = t('Unavailable');
  $array_send_status[1] = t('Available');

  $respons_array = array();

  // Mobile.ws always returned array.
  if (is_array($result)) {

    // Always the first element in this array is the status code.
    if (isset($result[0]) && is_numeric($result[0])) {

      if (isset($array_send_status[$result[0]])) {
        // Result is correct.
        $respons_array['status'] = $result[0];
        $respons_array['message'] = $array_send_status[$result[0]];
        return $respons_array;
      }

    }

  }

  // If the result is not valid we will return the error status.
  // Response structure is not correct.
  $respons_array['status'] = 2;
  $respons_array['message'] = t('An error occurred.');
  return $respons_array;
}

/**
 * Returns custom additions to be added to the send forms.
 */
function sms_mobilyws_send_form() {
  $form['country'] = array(
    '#type' => 'select',
    '#title' => t('Country'),
    '#multiple' => FALSE,
    '#options' => sms_country_codes(),
    '#default_value' => -1,
  );

  return $form;
}
